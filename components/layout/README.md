### Property value

![value](https://i.imgur.com/qkTmOFJ.png)

### Visual model

```
|-------------------------------------------------|
|                                                 |
|                  margin-top                     |
|                                                 |
|    |---------------------------------------|    |
|    |                                       |    |
|    |             border-top                |    |
|    |                                       |    |
|    |    |--------------------------|--|    |    |
|    |    |                          |  |    |    |
|    |    |       padding-top        |##|    |    |
|    |    |                          |##|    |    |
|    |    |    |----------------|    |##|    |    |
|    |    |    |                |    |  |    |    |
| ML | BL | PL |  content box   | PR |SW| BR | MR |
|    |    |    |                |    |  |    |    |
|    |    |    |----------------|    |  |    |    |
|    |    |                          |  |    |    |
|    |    |      padding-bottom      |  |    |    |
|    |    |                          |  |    |    |
|    |    |--------------------------|--|    |    |
|    |    |     scrollbar height ####|SC|    |    |
|    |    |-----------------------------|    |    |
|    |                                       |    |
|    |           border-bottom               |    |
|    |                                       |    |
|    |---------------------------------------|    |
|                                                 |
|                margin-bottom                    |
|                                                 |
|-------------------------------------------------|

BL = border-left
BR = border-right
ML = margin-left
MR = margin-right
PL = padding-left
PR = padding-right
SC = scroll corner
SW = scrollbar width
```

- Vertical scrollbar (if existing) will be on left in right-to-left direction horizontal writting mode, while horizontal scrollbar (if existing) is always at the bottom <- [illustration above and reference](https://chromium.googlesource.com/chromium/src/+/refs/heads/main/third_party/blink/renderer/core/layout/README.md#box-model).
- `box-sizing` changes which area `width`, `max/min-width`, `height`, `max/min-height` points to
  - `content-box` -> content area
  - `border-box` -> border area
- `display` establishes outer display (block/inline box) which defines how element's participation in [Normal Flow](https://www.w3.org/TR/CSS22/visuren.html#normal-flow) and inner display which defines formating context for its content.
- HTML elements generate zero or more boxes according to box model. How a box laid out according to box's type and position scheme (normal flow, float, and absolute positioning)

### Formatting model

![block](https://i.imgur.com/WrSJfCR.png)

#### Block

Block-level elements are formatted visually as block (occupy the entire horizontal space of its parent), and block-level elements generate block-level boxes which participle in a block formatting context. In block formatting context, boxes are laid out one after others vertically, beginning at the top of [a containing block](https://www.w3.org/TR/CSS22/visudet.html#containing-block-details).

Everything when rendering has to be in a box, in the example above there is no HTML element attached to, therefore, anonymous box is created. The properties of anonymous boxes are inherited from enclosing non-anonymous box (in example below is div), non-inherited properties have their initial value.

```html
<div>
  I am wrapped in an anonymous box
  <p>I am in the paragraph</p>
  I am wrapped in an anonymous box.
</div>
```

![anonymous box](https://i.imgur.com/qOrZtgL.png)

Anonymous box is also ignored when resolving percentage values, for example child of anonymous block box, which inside div, need to know its containing block height to resolve a percentage height, then it will use the height of div instead.

#### Inline

Inline-level elements do not form new block of content, and inline-level elements generate inline-level boxes which participate in an inline formating context. In inline formating context, boxes are laid out horizontally one after other, beginning at the top of a containning block.

In example below, p generates a block box, two anonymous boxes (for "Hello" and "my old friend") and another inline box is generated by `em`.

```html
<p>Hello <em>darkness</em>, my old friend</p>
```

### Stacking context

Each box belongs to one stacking context (it is formed in [following conditions](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context#the_stacking_context)) and describes [the order](https://www.w3.org/TR/CSS22/zindex.html#painting-order) in which rendering tree is painted.

[![hirerachy](https://i.imgur.com/TkAOJZi.png)](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context#the_example)

In the example above, every positioned elements create its own stacking context and we have a hierarchy of stacking context below.
Each stacking context is self-contained for example when rendering root we only care div #1, #2, #3 (belong to the same stacking context root) and then later when processing div #3, it is between div #4, #5, #6 (belongs to the same context div #3)

```
root
├── div #1
├── div #2
├── div #3
|   ├── div #4
|   ├── div #5
|   └── div #6
```

### Collapsing margins

[Collapsed margin](https://www.w3.org/TR/CSS22/box.html#collapsing-margins) is adjoining margins (apply event for zero margin) of two or more boxes (might or might not be siblings) are combined to form a single margin. Horizontal margins never collapse.

```html
<div id="1" style="margin: 10px 0">
  <p id="2" style="margin: 5px 0">ping</p>
</div>
<div id="3" style="margin: 15px 0 5px 0"></div>
<div id="4">
  <div id="5" style="margin: 20px 0">pong</div>
</div>
```

In the example above, margin bottoms of div#1 and p#2 are collapsed into 10px (A). Collapse through(top and bottom of a box are adjoining) happens for div#3, we have only one margin of 15px, then is collapsed with A to have 15px (B), later B is collapsed with margin top div#4 into 20px (div#1 and div#5 are not siblings).

### CSS Selector

#### Performance Tweak

There are [4 ways](https://calendar.perfplanet.com/2011/css-selector-performance-has-changed-for-the-better/) which are used by Webkit to improve performance ([77740](http://trac.webkit.org/changeset/77740/webkit), [77777](http://trac.webkit.org/changeset/77777/webkit))

- Style sharing: if browser has already calculated the p1's style, it can be reused for p2.
  ```html
  <div>
    <p>foo</p>
    <p>bar</p>
  </div>
  ```
- Rule hashes: since browser matches styles from right to left, we can group stylesheet by right most selector.
  ```scs1
  a {}
  div p {}
  div p.legal {}
  #sidebar a {}
  #sidebar p {}
  ```
  | a               |        p        |          p.legal |
  | --------------- | :-------------: | ---------------: |
  | `a {}`          |   `div p {}`    | `div p.legal {}` |
  | `#sidebar a {}` | `#sidebar p {}` |                  |
- Ancestor filters: use Bloom filter to test selector is probably in the set or not ([how Bloom filter works](https://www.jasondavies.com/bloomfilter/)).
- Fast path: re-implements matching logic for general matching logic using a non-recursive, fully inlined loop.

### Debugging

- We can view [layers information](https://developer.chrome.com/docs/devtools/evaluate-performance/reference/#layers) and how elements are painted in a canvas via [paint profiler](https://developer.chrome.com/docs/devtools/evaluate-performance/reference/#paint-profiler)

### Design

- Loop through stylesheet's css rules and build stylist's rules

```rs
// holds all selectors for a given document
struct Stylist {
  stylesheets: Vec<Stylesheet>,
  rules: Vec<Rule>,
  rules_source_order: u32,
}

struct Rule {
  selector: Selector<Selectors>,
  hashes: AncestorHashes,
  source_order: u32,
  style_rule: StyleRule,
}
```

- Traverse dom tree, each element find matched selectors and combine them with inline style -> transform them into list of `ApplicableDeclarationBlock` -> cascade to get computed values.

```rs
struct ApplicableDeclarationBlock {
  source: StyleSource,
  specificity: u32,
}

enum StyleSource {
  StyleRule(StyleRule),
  DeclarationBlock(PropertyDeclarationBlock),
}
```

- Traverse style tree to construct flow tree

```rs
// flow.rs
pub struct BaseBox {
  node: NodeRef,
  formatting_context: Rc<VisualFormattingContext>,
  stacking_context: Rc<StackingContext>,
}

// Block-level box is also a block container
pub struct BlockBox {
  base: BaseBox,
  children: Vec<VisualBox>, // only BlockBox and AnonymousBox
}

// Inline-level box is also a block container
pub struct InlineBox {
  base: BaseBox,
  children: Vec<VisualBox>, // only InlineBox and AnonymousBox
}

pub enum VisualBox {
  BlockBox(BlockBox),
  InlineBox(InlineBox),
  AnonymousBox(VisualBox),
}

pub enum FormattingContextType {
  BlockFormattingContext,
  InlineFormattingContext,
}

pub struct VisualFormattingContext {
  formatting_context_type: FormattingContextType,
  established_by: Weak<VisualBox>,
}

pub struct StackingContext {
  z_index: i32,
  generated_by: Weak<VisualBox>,
  children: Vec<StackingContext>,
}
```
